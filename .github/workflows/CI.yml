# This workflow will run tests using node and then publish a package to GitHub Packages when a release is created
# For more information see: https://help.github.com/actions/language-and-framework-guides/publishing-nodejs-packages

name: CI

on:
  push:
    branches: [develop]
  pull_request:
    branches: [develop]

jobs:
  build:
    name: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
      - uses: actions/checkout@v3

      - name: Setup Node 16
        uses: actions/setup-node@v2
        with:
          node-version: 16
        run: npm run build

  docker:
    name: docker
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Build the Docker image
      - uses: actions/checkout@v3
        run: export VERSION=$(node -p "require('./package.json').version")
        run: docker build . --file Dockerfile --tag Pumassi:$VERSION
        run: docker push Pumassi:$VERSION

  notice:
    name: notice
    runs-on: ubuntu-latest
    steps:
      - name: Notice to discord
      - uses: sarisia/actions-status-discord@v1
        if: always()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        with:
          nodetail: true
        title: 'Pumassi CI'
        description: 'Build Pumassi Server'
        color: 0x92BC79
        username: GitHub Actions
        avatar_url: https://www.google.com/url?sa=i&url=https%3A%2F%2Fduinaru.github.io%2Fposts%2F2020-09-11-deloy-github-pages-with-actions%2F&psig=AOvVaw0UJmw-h0XbhCtoOJyF7rvJ&ust=1652317287345000&source=images&cd=vfe&ved=0CAwQjRxqFwoTCIC3xdqf1vcCFQAAAAAdAAAAABAD
